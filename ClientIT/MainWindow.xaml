<Window
    x:Class="ClientIT.MainWindow"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:local="using:ClientIT"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:models="using:ClientIT.Models"
    x:Name="ThisPage"
    mc:Ignorable="d">
    
    <Window.SystemBackdrop>
        <MicaBackdrop/>
    </Window.SystemBackdrop>

    <!-- Layout Principale a 2 colonne -->
    <Grid x:Name="RootGrid" Padding="12">
        <Grid.ColumnDefinitions>
            <!-- Colonna Sinistra (Utenti IT) -->
            <ColumnDefinition Width="1*" MinWidth="200"/>
            <!-- Colonna Destra (Ticket) -->
            <ColumnDefinition Width="5*"/>
            <!-- Rapporto 1:5 -->
        </Grid.ColumnDefinitions>

        <!-- ProgressRing per il caricamento -->
        <ProgressRing x:Name="LoadingProgressRing" 
                      Grid.ColumnSpan="2"
                      IsActive="False"
                      Visibility="Collapsed"
                      Width="50" 
                      Height="50"
                      HorizontalAlignment="Center"
                      VerticalAlignment="Center"
                      Canvas.ZIndex="999"/>

        <!-- === COLONNA SINISTRA (Utenti IT) === -->
        <StackPanel Grid.Column="0" Margin="0,0,12,0" Spacing="8">

            <!-- Pulsante per resettare il filtro -->
            <Button x:Name="ShowAllButton" 
                    HorizontalAlignment="Stretch"
                    Click="ShowAllButton_Click"
                    Style="{ThemeResource AccentButtonStyle}">
                <StackPanel Orientation="Horizontal" Spacing="8">
                    <FontIcon Glyph="&#xE8A5;"/>
                    <!-- Icona per "Tutti i file" -->
                    <TextBlock Text="Mostra Tutti i Ticket"/>
                </StackPanel>
            </Button>

            <!-- Bordo per la lista utenti -->
            <Border Background="{ThemeResource LayerFillColorDefaultBrush}" 
                    CornerRadius="8" 
                    BorderThickness="1" 
                    BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}">

                <!-- Lista utenti cliccabile -->
                <ListView x:Name="UserListView" 
                          Margin="4"
                          SelectionMode="Single"
                          SelectionChanged="UserListView_SelectionChanged">
                    <ListView.ItemTemplate>
                        <DataTemplate x:DataType="models:ItUtente">
                            <StackPanel Padding="8">
                                <TextBlock Text="{x:Bind UsernameAd}" FontWeight="Bold"/>
                               <!-- <TextBlock Text="{x:Bind Permesso}" FontSize="12" Opacity="0.8"/> -->
                            </StackPanel>
                        </DataTemplate>
                    </ListView.ItemTemplate>
                </ListView>
            </Border>
        </StackPanel>


        <!-- === COLONNA DESTRA (Ticket) === -->
        <ScrollViewer Grid.Column="1" VerticalScrollBarVisibility="Auto">
            <StackPanel Spacing="8">
                <!-- Messaggio di Benvenuto -->
                <TextBlock x:Name="WelcomeMessage" 
                           Style="{ThemeResource TitleTextBlockStyle}" 
                           Margin="0,0,0,12"/>

                <!-- Lista dei Ticket -->
                <ListView x:Name="TicketListView" 
                          SelectionMode="Single"
                          HorizontalContentAlignment="Stretch">
                    <ListView.ItemTemplate>
                        <!-- Template per un singolo ticket -->
                        <DataTemplate x:DataType="models:TicketViewModel">
                            <Border Background="{ThemeResource LayerFillColorDefaultBrush}" 
                                    CornerRadius="8" 
                                    BorderThickness="1" 
                                    BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
                                    Padding="16" 
                                    Margin="0,0,0,8">
                                <StackPanel Spacing="8">
                                    <!-- Riga Titolo + N. Ticket -->
                                    <Grid>
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="*"/>
                                            <ColumnDefinition Width="Auto"/>
                                        </Grid.ColumnDefinitions>
                                        <TextBlock Grid.Column="0" 
                                                   Text="{x:Bind Titolo}" 
                                                   Style="{ThemeResource SubtitleTextBlockStyle}" 
                                                   FontWeight="Bold" 
                                                   VerticalAlignment="Center"/>
                                        <TextBlock Grid.Column="1" 
                                                   Text="{x:Bind Nticket}" 
                                                   Opacity="0.7" 
                                                   VerticalAlignment="Center"/>
                                    </Grid>

                                    <!-- Riga per i "Badge" -->
                                    <StackPanel Orientation="Horizontal" Spacing="8" Margin="0,4,0,0">

                                        <!-- Badge Stato (NUOVO) -->
                                        <Border Background="{ThemeResource AccentFillColorSecondaryBrush}" 
                                                CornerRadius="4" 
                                                Padding="8,4">
                                            <TextBlock Text="{x:Bind StatoNome}" 
                                                       FontSize="12" 
                                                       FontWeight="Bold"
                                                       Foreground="{ThemeResource TextOnAccentFillColorPrimaryBrush}"/>
                                        </Border>

                                        <!-- Badge Tipologia -->
                                        <Border Background="{ThemeResource AccentFillColorDefaultBrush}" 
                                                CornerRadius="4" 
                                                Padding="8,4">
                                            <TextBlock Text="{x:Bind TipologiaNome}" 
                                                       FontSize="12" 
                                                       Foreground="{ThemeResource TextOnAccentFillColorPrimaryBrush}"/>
                                        </Border>
                                        <!-- Badge Urgenza -->
                                        <Border Background="{ThemeResource CardBackgroundFillColorDefaultBrush}" 
                                                CornerRadius="4" 
                                                Padding="8,4">
                                            <TextBlock Text="{x:Bind UrgenzaNome}" 
                                                       FontSize="12"
                                                       Foreground="{ThemeResource TextFillColorPrimary}"/>
                                        </Border>
                                        <!-- Badge Sede -->
                                        <Border Background="{ThemeResource CardBackgroundFillColorDefaultBrush}" 
                                                CornerRadius="4" 
                                                Padding="8,4">
                                            <TextBlock Text="{x:Bind SedeNome}" 
                                                       FontSize="12"
                                                       Foreground="{ThemeResource TextFillColorPrimary}"/>
                                        </Border>
                                    </StackPanel>
                                    <Grid ColumnSpacing="16" Margin="0,8,0,0">
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="*"/>
                                            <ColumnDefinition Width="*"/>
                                        </Grid.ColumnDefinitions>

                                        <ComboBox Grid.Column="0"
                                                  Header="Stato"
                                            ItemsSource="{Binding ElementName=ThisPage, Path=AllStati}"
                                                  
                                                  DisplayMemberPath="Nome"
                                                  SelectedValuePath="Id"
                                                  SelectedValue="{x:Bind StatoId, Mode=TwoWay}"
                                                  SelectionChanged="StatoComboBox_SelectionChanged"
                                                  Tag="{x:Bind Nticket}"/>

                                        <ComboBox Grid.Column="1"
                                                  Header="Assegnato a"                                                
                                            ItemsSource="{Binding ElementName=ThisPage, Path=AllItUsers}"
                                                  DisplayMemberPath="UsernameAd"
                                                  SelectedValuePath="Id"
                                                  SelectedValue="{x:Bind AssegnatoaId, Mode=TwoWay, TargetNullValue=0}"
                                                  SelectionChanged="AssegnatoaComboBox_SelectionChanged"
                                                  Tag="{x:Bind Nticket}"/>
                                    </Grid>

                                    <!-- Riga Utente, Macchina e Assegnato (NUOVO) -->
                                    <TextBlock Opacity="0.8" 
                                               FontSize="12" 
                                               Margin="0,8,0,0">
                                        <Run Text="Inviato da:"/>
                                        <Run Text="{x:Bind Username}" FontWeight="Bold"/>
                                        <Run Text=" | Macchina: "/>
                                        <Run Text="{x:Bind Macchina}" FontWeight="Bold"/>
                                        <Run Text=" | Assegnato a: "/>
                                        <Run Text="{x:Bind AssegnatoaNome}" FontWeight="Bold"/>
                                    </TextBlock>

                                </StackPanel>
                            </Border>
                        </DataTemplate>
                    </ListView.ItemTemplate>
                </ListView>
            </StackPanel>
        </ScrollViewer>

    </Grid>
</Window>